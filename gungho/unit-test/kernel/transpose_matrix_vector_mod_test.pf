!-----------------------------------------------------------------------------
! Copyright (c) 2017,  Met Office, on behalf of HMSO and Queen's Printer
! For further details please refer to the file LICENCE.original which you
! should have received as part of this distribution.
!-----------------------------------------------------------------------------
!
!-------------------------------------------------------------------------------
module transpose_matrix_vector_mod_test

  use constants_mod, only : r_double, r_single, i_def
  use pFUnit_Mod

  implicit none

  private
  public :: test_real64, test_real32

  @TestCase
  type, extends(TestCase), public :: transpose_matrix_vector_mod_test_type
    private
  contains
    procedure test_real64
    procedure test_real32
  end type transpose_matrix_vector_mod_test_type

contains

  @test
  subroutine test_real64(this)

    use transpose_matrix_vector_kernel_mod, only : transpose_matrix_vector_code

    implicit none

    class(transpose_matrix_vector_mod_test_type), intent(inout) :: this

    real(kind=r_double) :: d(4,2,1), x(4), y(2), answer(2)
    real(kind=r_double) :: tol
    integer(kind=i_def) :: i

    ! Make up a matrix
    d(1,:,1) = (/ 2.0_r_double, -2.0_r_double /)
    d(2,:,1) = (/ 3.0_r_double, -1.0_r_double /)
    d(3,:,1) = (/ 0.4_r_double,  1.3_r_double /)
    d(4,:,1) = (/ -4.5_r_double, 7.9_r_double /)
    ! rhs vector
    x(:) = (/ 0.25_r_double, 1.5_r_double, -0.35_r_double, 5.0_r_double /)
    ! lhs vector
    y(:) = 0.0_r_double
    answer = matmul(transpose(d(:,:,1)),x)

    call transpose_matrix_vector_code(1_i_def,              &
                                      1_i_def,              &
                                      y,                    &
                                      x,                    &
                                      1_i_def,              &
                                      d,                    &
                                      2_i_def,              &
                                      2_i_def,              &
                                      (/1_i_def, 2_i_def/), &
                                      4_i_def,              &
                                      4_i_def,              &
                                      (/1_i_def, 2_i_def, 3_i_def, 4_i_def/) )

    tol = 1.0e-14_r_double

    do i = 1,2
      @assertEqual( y(i), answer(i), tol )
    end do

  end subroutine test_real64

  @test
  subroutine test_real32(this)

    use transpose_matrix_vector_kernel_mod, only : transpose_matrix_vector_code

    implicit none

    class(transpose_matrix_vector_mod_test_type), intent(inout) :: this

    real(kind=r_single) :: d(4,2,1), x(4), y(2), answer(2)
    real(kind=r_single) :: tol
    integer(kind=i_def) :: i

    ! Make up a matrix
    d(1,:,1) = (/ 2.0_r_single, -2.0_r_single /)
    d(2,:,1) = (/ 3.0_r_single, -1.0_r_single /)
    d(3,:,1) = (/ 0.4_r_single,  1.3_r_single /)
    d(4,:,1) = (/ -4.5_r_single, 7.9_r_single /)
    ! rhs vector
    x(:) = (/ 0.25_r_single, 1.5_r_single, -0.35_r_single, 5.0_r_single /)
    ! lhs vector
    y(:) = 0.0_r_single
    answer = matmul(transpose(d(:,:,1)),x)

    call transpose_matrix_vector_code(1_i_def,              &
                                      1_i_def,              &
                                      y,                    &
                                      x,                    &
                                      1_i_def,              &
                                      d,                    &
                                      2_i_def,              &
                                      2_i_def,              &
                                      (/1_i_def, 2_i_def/), &
                                      4_i_def,              &
                                      4_i_def,              &
                                      (/1_i_def, 2_i_def, 3_i_def, 4_i_def/) )

    tol = 1.0e-6_r_single

    do i = 1,2
      @assertEqual( y(i), answer(i), tol )
    end do

  end subroutine test_real32

end module transpose_matrix_vector_mod_test
